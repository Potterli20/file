# This is a basic workflow to help you get started with Actions

name: DnsHosts-all

# Controls when the workflow will run
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"

# A workflow run is mDnsh up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 1  # ä¼˜åŒ–å…‹éš†æ·±åº¦
      
      - name: Cache dns data  # æ·»åŠ IDä»¥ä¾¿åç»­æ­¥éª¤å¼•ç”¨
        id: dns-cache
        uses: actions/cache@v4
        with:
          path: |
            ./file-hosts.sh/dns-hosts/hosts-dns
            ./Temp
          key: ${{ runner.os }}-dns-${{ hashFiles('**/dns-all.sh') }}-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-dns-${{ hashFiles('**/dns-all.sh') }}-
            ${{ runner.os }}-dns-
      
      - name: Check cache status  # æ·»åŠ ç¼“å­˜çŠ¶æ€æ£€æŸ¥
        run: |
          if [ "${{ steps.dns-cache.outputs.cache-hit }}" == 'true' ]; then
            echo "Cache hit - using cached DNS data"
            ls -la ./file-hosts.sh/dns-hosts/hosts-dns || true
          else
            echo "Cache miss - will generate fresh DNS data"
          fi

      - name: Build dns
        run: |
          bash ./file/bash/github-dns.sh
        continue-on-error: true  # å…è®¸ç»§ç»­æ‰§è¡Œ
        
      - name: Build GFWList2AGH
        id: build_gfw
        run: |
          bash ./file-hosts.sh/dns-hosts/dns-all.sh
        
      - name: Check build results  # æ£€æŸ¥æ„å»ºç»“æœ
        run: |
          if [ ! -d "./file-hosts.sh/dns-hosts/hosts-dns" ]; then
            echo "DNS hosts directory not found"
            exit 1
          fi
          
          if ! ls ./file-hosts.sh/dns-hosts/hosts-dns/dnshosts-all-* 1> /dev/null 2>&1; then
            echo "No DNS host files generated"
            exit 1
          fi
          
          echo "Found DNS host files:"
          ls -l ./file-hosts.sh/dns-hosts/hosts-dns/dnshosts-all-*
          
      - name: Update cache  # æ·»åŠ ç¼“å­˜æ›´æ–°æ­¥éª¤
        if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿå°è¯•æ›´æ–°ç¼“å­˜
        run: |
          if [ -d "./file-hosts.sh/dns-hosts/hosts-dns" ]; then
            echo "Updating DNS cache..."
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ¸…ç†ä¸´æ—¶æ–‡ä»¶çš„å‘½ä»¤
            find ./Temp -type f -name "*.tmp" -delete || true
          fi

      - name: Release
        uses: svenstaro/upload-release-action@master
        with:
          repo_token: ${{ secrets.GITHUBTOKEN }}
          tag: dns-hosts-all
          file_glob: true
          overwrite: true
          file: ./file-hosts.sh/dns-hosts/hosts-dns/dnshosts-all-*
          body: |
            ğŸ”„ DNS Hosts Update
            ğŸ“… Build Time: $(date '+%Y-%m-%d %H:%M:%S')
            ğŸ”¨ Workflow: ${{ github.workflow }}
            ğŸ“¦ Run: ${{ github.run_number }}
            ğŸ” Cache: ${{ steps.dns-cache.outputs.cache-hit == 'true' && 'âœ… Used' || 'âŒ Fresh Build' }}
